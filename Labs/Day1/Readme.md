# Refactoring "TheatricalPlays"
Background: 

This project contains a bill generator for a theatrical company.
This company charges their customers based on the size of the audience and the type of play.
Currently they are using a .NET 5 console application to generate a plain text bill.

Beside providing a bill, it also outputs the customers "volume credits", which is used to calculate a discount for repeat customers.
Every 10 credits earns a customer 1 percentage point up to a maximum discount of 30% of the total bill.

The plays this company can perform are stored in a simple JSON file.
In another JSON file are the performances stored that were performed for a customer containing the playid and the audience.

## Target Environment
* .NET Core 5.0
* This lab expects the default keybindings. If you're using a different keymap, please look up the keyboard shortcuts used in this lab.

### Build
* Visual Studio 2019 v16.8+ 

# Goal
The company wants to perform more types of plays. 
They hope to perform: historical, pastoral, pastoral-comical, historical-pastoral, tragical-comical-historical-pastoral and poem unlimited
Although the pricing structure and the volume credit calculations are not fully worked out, it appears that this will be under subject of change in the near future.

Furthermore, the company wants to send out HTML formatted statements to some customers.

In order to do so, you would either have to copy-paste the current `BillGenerator.Statement` implementation into a HTML statement generator with all code duplicated.

Or, first refactor the current implementation to a improved design more suitable for the upcoming features/requests.

In this lab we are going to perform the steps needed for the latter (of course :))

# First steps
## Extract function
As a first step, let's begin by extracting functionality from the current long `Statement` function.
The `switch` statement related to calculating the charge of a performance is a good start as it is performs 1 thing that we can return in a method.

So we are going to perform a **Extract Method** on this statement.
Select line 22 till 40 in `BillGenerator.cs` and apply the **Extract method** refactoring from Visual Studio (either via Edit > Refactor > Extract Method or using the Ctrl+. "quick actions" > Extract )
And name the newly extracted function `AmountFor`. (We can always rename it later to a more suitable name).
We finish the first refactoring by running our unittests to verify that we did not break anything and committing the first change

Next, apply the **Rename variable** refactoring from Visual Studio on the `thisAmount` variable in the `AmountFor` method and rename it to `result`
Again compile-test-commit.

Apply the same **Rename variable** refactoring on the `perf` parameter of `AmountFor`. Rename it to `performance`, compile test and commit.

## Removing the `play` variable
The next refactoring we want to apply is regarding the `play` parameter. This parameter is just a computation based on the performance playID
and as we already have a Performance object as parameter, there should not be a need to pass it in as we could also calculate it ourselves.
Meaning that we want to remove the `play` parameter.

However here the design of the `Statement` method holds us back, because the dictionary containing all plays is a local parameter.
Meaning that we need to promote the `plays` parameter into a instance variable (in C# called Fields) of the class `BillGenerator`
Let's start with adding `private readonly IReadOnlyDictionary<string, Play> plays;` to the top of the class.

Now we *could* assign the `plays` parameter directly to the instance variable by using `this.plays = plays;` within the Statement method, 
however this would set us on a slippery slope as it would not be easy to separate between the local parameter and the instance variable.
Instead we want to signal to the users of `BillGenerator` that it always requires a `IReadOnlyDictionary<string, Play> plays` using the constructor.

The new constructor can automatically be generated by Visual Studio. 
Place the text cursor/caret somewhere within the `BillGenerator` on line 8 and bring up the "quick actions" menu using Ctrl+.
Select the "Generate constructor..." option. Press "OK" on the dialog and a constructor should be generated.
Now we can use the **_lean on compiler_** action to identify all the places that need to be changed due to the added constructor parameter.
Resolve each compiler error.

Finally we are going to switch into using the instance variable by removing the `plays` parameter using the **Change function declaration** refactoring.
Place the cursor somewhere on the line `public string Statement(Invoice invoice, IReadOnlyDictionary<string, Play> plays)` and bring up the "quick actions" menu.
Select the "Change signature..." option. In the dialog that opens, select the `plays` parameter, press the Remove button and finally press "OK" to apply the changes.
With this refactoring, the instance variable should now be used.
Test the changes to ensure that the external behavior was not modified and commit if all tests are green.

Next encapsulate the lookup of a play based on it's performance in a separate function.
Select this whole line `var play = plays[perf.PlayId];` (around line 28 within `Statement` function), 
apply the **Extract Method** refactoring and name the newly created method `PlaysFor`.
Compile-test-commit.

Apply the **Inline variable** refactoring on the `play` variable.
Place the cursor on the `play`, bring up the "quick actions" context menu and select the option "Inline temporary variable".
As always after a refactor action, compile-test-commit.

With this new `PlaysFor` function, we can begin removing the `play` parameter from the `AmountFor` function.
First, use the new function in `amountFor` by replacing the 2 usages of the `play` variable with a call to `PlaysFor(performance)`.
And as `AmountFor` now uses non-static methods, remove the static keyword.
Compile-test-commit

Then delete the now unused `play` parameter using the **Change function declaration** refactoring.
And compile-test-commit again.

As a final refactoring during this step, apply the **Inline variable** refactoring on the `thisAmount` variable

Your `BillGenerator` class should look something like the one in folder `src\01 First Steps`

# Extracting Volume Credits
Next we want to extract the `volumeCredits` calculation from the foreach loop.
Unfortunately due to `volumeCredits` accumulator, we cannot rely on the automated "Extract method" functionality.
Instead we are going to perform the **Extract Method** refactoring manually. 
First create a new method named `VolumeCreditsFor`:
```
private int VolumeCreditsFor(Performance perf)
{

}
```
Then copy the volume credit calculation block into `VolumeCreditsFor`:
```
private int VolumeCreditsFor(Performance perf)
{
    // add volume credits
    volumeCredits += Math.Max(perf.Audience - 30, 0);
    // add extra credit for every ten comedy attendees
    if (PlayType.Comedy == PlaysFor(perf).Type) volumeCredits += (int)Math.Floor((decimal)perf.Audience / 5);
}
```
Add the missing variable to resolve the compiler errors and return it:
```
private int VolumeCreditsFor(Performance perf)
{
    var volumeCredits = 0;
    // add volume credits
    volumeCredits += Math.Max(perf.Audience - 30, 0);
    // add extra credit for every ten comedy attendees
    if (PlayType.Comedy == PlaysFor(perf).Type) volumeCredits += (int)Math.Floor((decimal)perf.Audience / 5);

    return volumeCredits;
}
```

Replace to copied code with a call to `VolumeCreditsFor`:
```
            foreach (var perf in invoice.Performances)
            {
                volumeCredits += VolumeCreditsFor(perf);
```

Compile-test-commit the manual Extract Method refactoring.
Lastly, remove the unnecessary (and even misleading) comments and **Rename variable** in the new function, 
renaming `volumeCredits` to result and `perf` to `performance` with a compile-test-commit action for each rename.

Next we are going to remove the `volumeCredits` from `Statement`.
As it is nested in the foreach loop, we are going to apply the **Split Loop** refactoring (see slides)
```
            foreach (var perf in invoice.Performances)
            {
                // print line for this order
                result.Append($"  {this.PlaysFor(perf).Name}: {(AmountFor(perf) / 100).ToString("C", format)}");
                result.AppendLine($" ({perf.Audience} seats)");
                totalAmount += AmountFor(perf);
            }

            foreach (var perf in invoice.Performances)
            {
                volumeCredits += VolumeCreditsFor(perf);
            }
```
Compile-test-commit

Then using **Slide Statements** (see hidden slide 20) move the declaration of the `volumeCredits` variable before the loop:
```
            var volumeCredits = 0;
            foreach (var perf in invoice.Performances)
            {
                volumeCredits += VolumeCreditsFor(perf);
            }
```
Compile-test-commit

Gathering this all together means that we can now use the automated **Extract Method** refactoring to create a new method `TotalVolumeCredits`.
After compiling, testing and committing; apply **Inline variable** on `volumeCredits`

Your `BillGenerator` class should look something like the one in folder `src\02 Extract Volume Credits`

# More extractions
In order to remove the variable `totalAmount` we can use the same steps as before.
First **Split loop* on the first foreach loop.
After this refactoring it should look like below:
```
            foreach (var perf in invoice.Performances)
            {
                // print line for this order
                result.Append($"  {this.PlaysFor(perf).Name}: {(AmountFor(perf) / 100).ToString("C", format)}");
                result.AppendLine($" ({perf.Audience} seats)");
            }

            foreach (var perf in invoice.Performances)
            {
                totalAmount += AmountFor(perf);
            }
```
Compile-test-commit.

Then using **Slide Statements** on `decimal totalAmount = 0;` closer to the loop. 
Compile-test-commit
Select all the lines related to calculating `totalAmount`, including the discount, and apply **Extract Method** refactoring to create a new method `TotalAmount`.
Compile-test-commit
**Inline variable** `totalAmount` (compile-test-commit) in `Statement`  function.
In `TotalAmount` method **Rename variable** `totalAmount` to `result`

Lastly let's extract the currency formatting.
As both the `AmountFor(perf)` and `TotalAmount(invoice)` use the same kind of code, let's **Extract method** on this functionality.
Here we need to again perform a manual refactoring as the automated tooling does not suffice.
Given that this method will format an amount into USD, we could name it as `FormatAsUSD` but `Usd` is just as suggestive so we go with latter.
```c#
        private string Usd(decimal amount)
        {

        }
```

Next, move the code related to the amount formatting in the new function:
```

        private string Usd(decimal amount)
        {
            IFormatProvider format = new CultureInfo("en-US");
            return (amount / 100).ToString("C", format);
        }
```
Note that we included the duplicate division by 100 into the `Usd` method.
Now, replace the number formatting with the `Usd` method. 
Testing after each replacement.
Remove the used `format` variable from `Statement`

As a final refactoring in this part, **Inline variable** on `format` in `Usd`

Your `BillGenerator` class should look something like the one in folder `src\03 More extractions`

# Split phase and adding render HTML

# Calculations by type